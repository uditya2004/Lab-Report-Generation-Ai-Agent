<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Experiment Report Generator</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --bg: #ffffff;
        --surface: #ffffff;
        --border: #e5e7eb;
        --text: #111827;
        --text-secondary: #6b7280;
        --success: #10b981;
        --error: #ef4444;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }

      header {
        text-align: center;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }

      header h1 {
        font-size: 28px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 8px;
      }

      header p {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .main-content {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 24px;
        min-height: calc(100vh - 180px);
      }

      .form-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 24px;
        height: fit-content;
        position: sticky;
        top: 24px;
      }

      .form-panel h2 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        margin-bottom: 6px;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--surface);
        color: var(--text);
        transition: border-color 0.15s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
      }

      .form-group .hint {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        width: 100%;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-hover);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: var(--surface);
        color: var(--text);
        border: 1px solid var(--border);
        margin-top: 12px;
      }

      .btn-secondary:hover:not(:disabled) {
        background: var(--bg);
      }

      .btn-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .preview-panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--bg);
      }

      .preview-header h2 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
      }

      .status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--border);
      }

      .status-dot.generating {
        background: var(--primary);
        animation: pulse 1.5s infinite;
      }

      .status-dot.complete {
        background: var(--success);
      }

      .status-dot.error {
        background: var(--error);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      .preview-content {
        flex: 1;
        overflow-y: auto;
        padding: 24px 32px;
        background: #ffffff;
      }

      .markdown-body {
        font-size: 15px;
        line-height: 1.6;
        background: #ffffff !important;
        color: #111827 !important;
      }

      .markdown-body h1,
      .markdown-body h2,
      .markdown-body h3,
      .markdown-body h4 {
        color: #111827 !important;
      }

      .markdown-body h2 {
        margin-top: 24px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
      }

      .markdown-body h3 {
        margin-top: 20px;
      }

      .markdown-body ul,
      .markdown-body ol,
      .markdown-body li,
      .markdown-body p {
        color: #111827 !important;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 400px;
        color: var(--text-secondary);
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.4;
      }

      .empty-state p {
        font-size: 14px;
      }

      .progress-container {
        margin-top: 16px;
        display: none;
      }

      .progress-container.visible {
        display: block;
      }

      .progress-bar {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary);
        width: 0%;
        transition: width 0.3s;
      }

      .progress-text {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
        text-align: center;
      }

      .tag-input {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        min-height: 42px;
        cursor: text;
      }

      .tag-input:focus-within {
        border-color: var(--primary);
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 13px;
      }

      .tag button {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border: none;
        background: none;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 14px;
      }

      .tag button:hover {
        color: var(--error);
      }

      .tag-input input {
        flex: 1;
        min-width: 120px;
        border: none;
        outline: none;
        font-size: 13px;
        padding: 4px;
      }

      @media (max-width: 900px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .form-panel {
          position: static;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸ“„ Experiment Report Generator</h1>
        <p>Generate professional academic experiment reports with AI</p>
      </header>

      <div class="main-content">
        <div class="form-panel">
          <h2>Report Configuration</h2>

          <form id="reportForm">
            <div class="form-group">
              <label for="subject">Subject Name</label>
              <input
                type="text"
                id="subject"
                name="subject"
                placeholder="e.g., Software Engineering"
                required
              />
            </div>

            <div class="form-group">
              <label>Headings</label>
              <div class="tag-input" id="headingsInput">
                <input
                  type="text"
                  placeholder="Type and add comma"
                  id="headingField"
                />
              </div>
              <p class="hint">Add comma to create each heading</p>
            </div>

            <div class="form-group">
              <label for="experiments">Experiments</label>
              <textarea
                id="experiments"
                name="experiments"
                placeholder="Enter one experiment per line:&#10;Online Student Registration System&#10;Library Management System&#10;Railway Ticket Booking"
                required
              ></textarea>
              <p class="hint">One experiment per line</p>
            </div>

            <button type="submit" class="btn btn-primary" id="generateBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M12 5v14M5 12h14" />
              </svg>
              Generate Report
            </button>

            <div class="progress-container" id="progressContainer">
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
              </div>
              <p class="progress-text" id="progressText">Generating...</p>
            </div>

            <button
              type="button"
              class="btn btn-secondary"
              id="copyBtn"
              disabled
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
              </svg>
              Copy Markdown
            </button>
          </form>
        </div>

        <div class="preview-panel">
          <div class="preview-header">
            <h2>Preview</h2>
            <div class="status">
              <span class="status-dot" id="statusDot"></span>
              <span id="statusText">Ready</span>
            </div>
          </div>

          <div class="preview-content" id="previewContent">
            <div class="empty-state" id="emptyState">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <path
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                />
              </svg>
              <p>Fill in the form and click Generate to create your report</p>
            </div>
            <div class="markdown-body" id="markdownPreview"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // State
      let headings = ["Aim", "Theory", "Functional Requirements", "Non-Functional Requirements"];
      let isGenerating = false;
      let eventSource = null;
      let currentMarkdown = ""; // Store current markdown

      // DOM Elements
      const form = document.getElementById("reportForm");
      const generateBtn = document.getElementById("generateBtn");
      const copyBtn = document.getElementById("copyBtn");
      const headingsInput = document.getElementById("headingsInput");
      const headingField = document.getElementById("headingField");
      const markdownPreview = document.getElementById("markdownPreview");
      const emptyState = document.getElementById("emptyState");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");

      // Initialize with default headings
      function init() {
        headings.forEach((h) => addHeadingTag(h));
      }

      // Heading tag management
      function addHeadingTag(text) {
        const tag = document.createElement("span");
        tag.className = "tag";
        tag.innerHTML = `
          ${text}
          <button type="button" onclick="removeHeading(this, '${text}')">&times;</button>
        `;
        headingsInput.insertBefore(tag, headingField);
      }

      function removeHeading(btn, text) {
        headings = headings.filter((h) => h !== text);
        btn.parentElement.remove();
      }

      headingField.addEventListener("keydown", (e) => {
        if (e.key === ",") {
          e.preventDefault();
          const value = headingField.value.trim();
          if (value && !headings.includes(value)) {
            headings.push(value);
            addHeadingTag(value);
            headingField.value = "";
          }
        }
      });

      headingsInput.addEventListener("click", () => {
        headingField.focus();
      });

      // Status updates
      function setStatus(type, text) {
        statusDot.className = "status-dot " + type;
        statusText.textContent = text;
      }

      // Render markdown
      function renderMarkdown(md) {
        if (md && md.trim()) {
          emptyState.style.display = "none";
          markdownPreview.innerHTML = marked.parse(md);
          markdownPreview.style.display = "block";
        } else {
          emptyState.style.display = "flex";
          markdownPreview.style.display = "none";
        }
      }

      // Start streaming updates
      function startStreaming() {
        if (eventSource) {
          eventSource.close();
        }

        eventSource = new EventSource("/api/stream");
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          renderMarkdown(data.markdown);
        };
      }

      // Form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (isGenerating) return;

        const subject = document.getElementById("subject").value.trim();
        const experimentsText = document.getElementById("experiments").value.trim();
        const experiments = experimentsText
          .split("\n")
          .map((e) => e.trim())
          .filter((e) => e);

        if (!subject || experiments.length === 0 || headings.length === 0) {
          alert("Please fill in all fields");
          return;
        }

        // Clear previous data
        currentMarkdown = "";
        markdownPreview.innerHTML = "";
        emptyState.style.display = "flex";
        markdownPreview.style.display = "none";

        isGenerating = true;
        generateBtn.disabled = true;
        copyBtn.disabled = true;
        progressContainer.classList.add("visible");
        progressFill.style.width = "0%";
        setStatus("generating", "Generating...");

        // Remove streaming (not needed with in-memory storage)
        // startStreaming();

        // Simulate progress
        let progress = 0;
        const totalExperiments = experiments.length;
        const progressInterval = setInterval(() => {
          if (progress < 90) {
            progress += Math.random() * 5;
            progressFill.style.width = Math.min(progress, 90) + "%";
            progressText.textContent = `Generating report...`;
          }
        }, 500);

        try {
          const response = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subject, experiments, headings }),
          });

          const data = await response.json();

          clearInterval(progressInterval);
          progressFill.style.width = "100%";

          if (data.success) {
            renderMarkdown(data.markdown);
            currentMarkdown = data.markdown; // Store markdown
            setStatus("complete", "Complete");
            copyBtn.disabled = false;
            progressText.textContent = "Report generated successfully!";
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          clearInterval(progressInterval);
          setStatus("error", "Error");
          progressText.textContent = "Error: " + error.message;
          console.error(error);
        } finally {
          isGenerating = false;
          generateBtn.disabled = false;

          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }

          setTimeout(() => {
            progressContainer.classList.remove("visible");
          }, 3000);
        }
      });

      // Copy Markdown to clipboard
      copyBtn.addEventListener("click", async () => {
        if (!currentMarkdown) {
          alert("Please generate a report first");
          return;
        }

        try {
          await navigator.clipboard.writeText(currentMarkdown);
          
          // Show success feedback
          const originalHTML = copyBtn.innerHTML;
          copyBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Copied!
          `;
          copyBtn.style.background = "var(--success)";
          copyBtn.style.borderColor = "var(--success)";
          copyBtn.style.color = "white";
          
          setTimeout(() => {
            copyBtn.innerHTML = originalHTML;
            copyBtn.style.background = "";
            copyBtn.style.borderColor = "";
            copyBtn.style.color = "";
          }, 2000);
        } catch (error) {
          console.error("Copy failed:", error);
          alert("Failed to copy to clipboard");
        }
      });

      // Initialize
      init();
    </script>
  </body>
</html>
